#ZGFuaWVsYWJyYW9zdWJtaXNzaW9u
---
#- name: Copying files from CircleCI to Server
#  copy:
#    src: /root/project/backend
#    dest: /home/ubuntu
- name: Stopping PM2
  ignore_errors: yes
  shell: |
    cd /home/ubuntu/backend
    pm2 stop backend
    pm2 delete backend
- name: Installing node dependencies
  shell: |
    cd /home/ubuntu/backend
    npm install
- name: Building node service
  shell: |
    cd /home/ubuntu/backend
    npm run build
    npm run prestart:prod
- name: Run node migrations and saving to MemStash.io
  shell: |
    cd /home/ubuntu/backend
    npm run migrations > migrations.txt
    curl -H "Content-Type: text/plain" -H "token: ${ "{{ lookup('env', 'MEMSTASH_TOKEN') }}" }" --request PUT --data "$(cat migrations.txt)" https://api.memstash.io/values/migrations
- name: Start PM2
  shell: |
    cd /home/ubuntu/backend
    pm2 start npm --name backend -- start
