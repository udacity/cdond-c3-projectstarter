version: 2.1

jobs:
  audit:
    docker:
      - image: node:12.18.1
    steps:
      - checkout
      - run:
          name: Audit frontend packages
          command: |
            cd frontend
            npm audit --audit-level=critical
      - run:
          name: Audit backend packages
          command: |
            cd backend
            npm audit --audit-level=critical
  frontend:
    docker:
      - image: node:12.18.1
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd frontend
            npm install
      - run:
          name: Test app
          command: |
            cd frontend
            npm run test
      - run:
          name: Build app
          command: |
            cd frontend
            npm run build
  backend:
    docker:
      - image: node:12.18.1
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            cd backend
            npm install
      - run:
          name: Build app
          command: |
            cd backend
            npm run build
      - run:
          name: Test app
          command: |
            cd backend
            npm run test
  deploy_infrastructure:
    docker:
      - image: amazon/aws-cli
    steps:
      - checkout
      - run:
          name: Deploy network
          command: |
            aws cloudformation deploy \
              --template-file network.yml \
              --stack-name udapeople-stack-network
      - run:
          name: Deploy cloudfront
          command: |
            aws cloudformation deploy \
              --template-file cloudfront.yml \
              --stack-name udapeople-stack-cloudfront
      - run:
          name: Deploy backend
          command: |
            aws cloudformation deploy \
              --template-file backend.yml \
              --stack-name udapeople-stack-backend
  configure_infrastructure:
    docker:
      - image: python:3.7-alpine3.11
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints: ["21:19:c0:15:0f:12:94:29:80:f0:01:51:c2:b3:e8:97"]
      - run:
          name: Install dependencies
          command: |
            apk add --update ansible # install the dependencies needed for your playbook
      - run:
          name: Configure server
          command: |
            ansible-playbook -i inventory.txt playbook.yml
workflows:
  default:
    jobs:
      - audit
      - frontend:
          requires:
            - audit
      - backend:
          requires:
            - audit
      - deploy_infrastructure:
          requires:
            - frontend
            - backend
